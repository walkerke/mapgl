<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Query rendered features on a map in a Shiny session — query_rendered_features • mapgl</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Query rendered features on a map in a Shiny session — query_rendered_features"><meta name="description" content="This function queries features that are currently rendered (visible) in the map viewport.
Only features within the current viewport bounds will be returned - features outside the
visible area or hidden due to zoom constraints will not be included. Use get_queried_features()
to retrieve the results as an sf object, or use the callback parameter to handle results
automatically when they're ready."><meta property="og:description" content="This function queries features that are currently rendered (visible) in the map viewport.
Only features within the current viewport bounds will be returned - features outside the
visible area or hidden due to zoom constraints will not be included. Use get_queried_features()
to retrieve the results as an sf object, or use the callback parameter to handle results
automatically when they're ready."><meta property="og:image" content="https://walker-data.com/mapgl/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mapgl</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span></a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/getting-started.html">Getting started with mapgl</a></li>
    <li><a class="dropdown-item" href="../articles/layers-overview.html">An overview of layers in mapgl</a></li>
    <li><a class="dropdown-item" href="../articles/map-design.html">Fundamentals of map design with mapgl</a></li>
    <li><a class="dropdown-item" href="../articles/shiny.html">Using mapgl with Shiny</a></li>
    <li><a class="dropdown-item" href="../articles/story-maps.html">Building story maps with mapgl</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/walkerke/mapgl/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Query rendered features on a map in a Shiny session</h1>
      <small class="dont-index">Source: <a href="https://github.com/walkerke/mapgl/blob/HEAD/R/query_rendered_features.R" class="external-link"><code>R/query_rendered_features.R</code></a></small>
      <div class="d-none name"><code>query_rendered_features.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function queries features that are currently rendered (visible) in the map viewport.
Only features within the current viewport bounds will be returned - features outside the
visible area or hidden due to zoom constraints will not be included. Use <code><a href="get_queried_features.html">get_queried_features()</a></code>
to retrieve the results as an sf object, or use the <code>callback</code> parameter to handle results
automatically when they're ready.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">query_rendered_features</span><span class="op">(</span></span>
<span>  <span class="va">proxy</span>,</span>
<span>  geometry <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  layer_id <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  filter <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  callback <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-proxy">proxy<a class="anchor" aria-label="anchor" href="#arg-proxy"></a></dt>
<dd><p>A MapboxGL or Maplibre proxy object, defined with <code><a href="mapboxgl_proxy.html">mapboxgl_proxy()</a></code>, <code><a href="maplibre_proxy.html">maplibre_proxy()</a></code>,
<code><a href="mapboxgl_compare_proxy.html">mapboxgl_compare_proxy()</a></code>, or <code><a href="maplibre_compare_proxy.html">maplibre_compare_proxy()</a></code></p></dd>


<dt id="arg-geometry">geometry<a class="anchor" aria-label="anchor" href="#arg-geometry"></a></dt>
<dd><p>The geometry to query. Can be:</p><ul><li><p><code>NULL</code> (default): Query the entire viewport</p></li>
<li><p>A length-2 vector <code>c(x, y)</code>: Query at a single point in pixel coordinates</p></li>
<li><p>A length-4 vector <code>c(xmin, ymin, xmax, ymax)</code>: Query within a bounding box in pixel coordinates</p></li>
</ul></dd>


<dt id="arg-layer-id">layer_id<a class="anchor" aria-label="anchor" href="#arg-layer-id"></a></dt>
<dd><p>A character vector of layer names to include in the query.
Can be a single layer name or multiple layer names. If <code>NULL</code> (default), all layers are queried.</p></dd>


<dt id="arg-filter">filter<a class="anchor" aria-label="anchor" href="#arg-filter"></a></dt>
<dd><p>A filter expression used to filter features in the query. Should be a list
representing a Mapbox GL expression. Using this parameter applies the filter during the
query WITHOUT changing the map display, avoiding race conditions. If you've called
<code><a href="set_filter.html">set_filter()</a></code> separately, you must pass the same filter here to get aligned results.</p></dd>


<dt id="arg-callback">callback<a class="anchor" aria-label="anchor" href="#arg-callback"></a></dt>
<dd><p>A function to execute when results are ready. The function will receive the sf object as its argument.
If provided, this avoids timing issues by automatically handling results when they're available.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>The proxy object (invisibly). Use <code><a href="get_queried_features.html">get_queried_features()</a></code> to retrieve the query results manually,
or provide a <code>callback</code> function to handle results automatically.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>

<div class="section">
<h3 id="viewport-limitation">Viewport Limitation<a class="anchor" aria-label="anchor" href="#viewport-limitation"></a></h3>


<p>This function only queries features that are currently rendered in the map viewport. Features
outside the visible area will not be returned, even if they exist in the data source. This
includes features that are:</p><ul><li><p>Outside the current map bounds</p></li>
<li><p>Hidden due to zoom level constraints (minzoom/maxzoom)</p></li>
<li><p>Not yet loaded (if using vector tiles)</p></li>
</ul></div>

<div class="section">
<h3 id="avoiding-race-conditions">Avoiding Race Conditions<a class="anchor" aria-label="anchor" href="#avoiding-race-conditions"></a></h3>


<p><strong>IMPORTANT</strong>: <code><a href="set_filter.html">set_filter()</a></code> is asynchronous while <code>query_rendered_features()</code> is synchronous.
Calling <code>query_rendered_features()</code> immediately after <code><a href="set_filter.html">set_filter()</a></code> will return features from the
PREVIOUS filter state, not the new one.</p><div class="section">
<h4 id="safe-usage-patterns-">Safe Usage Patterns:<a class="anchor" aria-label="anchor" href="#safe-usage-patterns-"></a></h4>


<p><strong>Pattern 1: Query First, Then Filter (Recommended)</strong></p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu"><a href="../reference/query_rendered_features.html">query_rendered_features</a></span><span class="op">(</span><span class="va">proxy</span>, layer_id <span class="op">=</span> <span class="st">"counties"</span>, callback <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">features</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Process features, then update map based on results</span></span>
<span>  <span class="va">proxy</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/set_filter.html">set_filter</a></span><span class="op">(</span><span class="st">"highlight"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"in"</span>, <span class="st">"id"</span>, <span class="va">features</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre><p></p></div>
<p><strong>Pattern 2: Use Filter Parameter Instead</strong></p>
<p></p><div class="sourceCode r"><pre><code><span><span class="co"># Query with filter without changing map display</span></span>
<span><span class="fu"><a href="../reference/query_rendered_features.html">query_rendered_features</a></span><span class="op">(</span><span class="va">proxy</span>, filter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"&gt;="</span>, <span class="st">"population"</span>, <span class="fl">1000</span><span class="op">)</span>,</span>
<span>                         callback <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">features</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Process filtered results without race condition</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre><p></p></div>
</div>

<div class="section">
<h4 id="what-not-to-do-">What NOT to Do:<a class="anchor" aria-label="anchor" href="#what-not-to-do-"></a></h4>


<p></p><div class="sourceCode r"><pre><code><span><span class="co"># WRONG - This will return stale results!</span></span>
<span><span class="va">proxy</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/set_filter.html">set_filter</a></span><span class="op">(</span><span class="st">"layer"</span>, <span class="va">new_filter</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/query_rendered_features.html">query_rendered_features</a></span><span class="op">(</span><span class="va">proxy</span>, layer_id <span class="op">=</span> <span class="st">"layer"</span><span class="op">)</span>  <span class="co"># Gets OLD filter results</span></span></code></pre><p></p></div>
</div>


</div>

    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Pattern 1: Query first, then filter (RECOMMENDED)</span></span></span>
<span class="r-in"><span><span class="va">proxy</span> <span class="op">&lt;-</span> <span class="fu"><a href="maplibre_proxy.html">maplibre_proxy</a></span><span class="op">(</span><span class="st">"map"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">query_rendered_features</span><span class="op">(</span><span class="va">proxy</span>, layer_id <span class="op">=</span> <span class="st">"counties"</span>, callback <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">features</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">features</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="co"># Filter map based on query results - no race condition</span></span></span>
<span class="r-in"><span>    <span class="va">proxy</span> <span class="op">|&gt;</span> <span class="fu"><a href="set_filter.html">set_filter</a></span><span class="op">(</span><span class="st">"selected"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"in"</span>, <span class="st">"id"</span>, <span class="va">features</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span><span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Pattern 2: Use filter parameter to avoid race conditions</span></span></span>
<span class="r-in"><span><span class="fu">query_rendered_features</span><span class="op">(</span><span class="va">proxy</span>,</span></span>
<span class="r-in"><span>                        filter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"&gt;="</span>, <span class="st">"population"</span>, <span class="fl">50000</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                        callback <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">features</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="co"># These results are guaranteed to match the filter</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Found"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">features</span><span class="op">)</span>, <span class="st">"high population areas"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Query specific bounding box with callback</span></span></span>
<span class="r-in"><span><span class="fu">query_rendered_features</span><span class="op">(</span><span class="va">proxy</span>, geometry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span>, <span class="fl">200</span>, <span class="fl">200</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                        layer_id <span class="op">=</span> <span class="st">"counties"</span>, callback <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">features</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Found"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">features</span><span class="op">)</span>, <span class="st">"features"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># ANTI-PATTERN - Don't do this!</span></span></span>
<span class="r-in"><span><span class="co"># proxy |&gt; set_filter("layer", new_filter)</span></span></span>
<span class="r-in"><span><span class="co"># query_rendered_features(proxy, layer_id = "layer")  # Will get stale results!</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://walker-data.com" class="external-link">Kyle Walker</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.9000.</p>
</div>

    </footer></div>





  </body></html>

